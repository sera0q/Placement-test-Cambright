import React, { useState, useEffect } from "react";
import "tailwindcss/tailwind.css";
import logo from "./Cambright.Lan.png";

export default function SecureExam() {
  const [started, setStarted] = useState(false);
  const [timeLeft, setTimeLeft] = useState(3000);

  useEffect(() => {
    if (started) {
      const timer = setInterval(() => {
        setTimeLeft((prev) => {
          if (prev === 601) {
            alert("You have 10 minutes remaining. Please complete the writing section before time is upâ€”it is very important!");
          }
          if (prev <= 0) {
            clearInterval(timer);
            autoSubmitForm();
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
      return () => clearInterval(timer);
    }
  }, [started]);

  useEffect(() => {
    const blockKeys = (e) => {
      if (e.key === "PrintScreen" || e.key === "F12" || e.key === "Escape" || (e.ctrlKey && ["c", "v", "x", "s", "u"].includes(e.key.toLowerCase()))) {
        alert("Screenshots are not allowed!");
        document.body.classList.add("blur-sm");
        setTimeout(() => document.body.classList.remove("blur-sm"), 3000);
        e.preventDefault();
        return false;
      }
    };

    const blockContextMenu = (e) => {
      e.preventDefault();
      alert("Right-click is disabled for security reasons.");
    };

    document.addEventListener("keydown", blockKeys);
    document.addEventListener("contextmenu", blockContextMenu);

    return () => {
      document.removeEventListener("keydown", blockKeys);
      document.removeEventListener("contextmenu", blockContextMenu);
    };
  }, []);

  useEffect(() => {
    const detectSnippingTool = setInterval(() => {
      if (window.outerWidth - window.innerWidth > 100 || window.outerHeight - window.innerHeight > 100) {
        document.body.classList.add("blur-sm");
        alert("Screen capture detected! Content is now blurred.");
        setTimeout(() => document.body.classList.remove("blur-sm"), 3000);
      }
    }, 1000);
    return () => clearInterval(detectSnippingTool);
  }, []);

  const autoSubmitForm = () => {
    alert("Time is up! Your answers are being submitted automatically.");
    try {
      const iframe = document.getElementById("examFrame");
      const submitButton = iframe.contentWindow.document.querySelector("[type=submit]");
      if (submitButton) {
        submitButton.click();
      } else {
        alert("Error: Could not auto-submit. Please submit manually.");
      }
    } catch (e) {
      alert("Error: Auto-submit blocked. Please submit manually.");
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100">
      {!started ? (
        <div className="text-center p-8 bg-white shadow-lg rounded-lg">
          <img src={logo} alt="Cambright Language Centre" className="mx-auto w-64 mb-4" />
          <h1 className="text-2xl font-bold">Welcome to the English Placement Test</h1>
          <p className="mt-2 text-gray-600">Our English Placement Test is designed to assess your current proficiency level and help us recommend the most suitable learning program for you.</p>
          <button
            className="mt-6 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-800"
            onClick={() => setStarted(true)}
          >
            Start Test
          </button>
        </div>
      ) : (
        <div className="w-full max-w-4xl bg-white shadow-lg rounded-lg p-6 text-center">
          <h1 className="text-xl font-bold">Secure Exam</h1>
          <p className="text-red-600 font-bold">Time Left: {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, "0")}</p>
          <iframe
            id="examFrame"
            src="https://docs.google.com/forms/d/e/1FAIpQLSfpBaiBgM_dhm93cIwG9kWKZFSx7E8XM2UxRkb3GOo939GRjA/viewform?usp=header"
            className="w-full h-[500px] border-none mt-4"
            allowFullScreen
          ></iframe>
        </div>
      )}
    </div>
  );
}
